<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToolManager AI</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f7fa; }
    .container { max-width: 1200px; margin: 0 auto; }
    .upload { 
      border: 3px dashed #ccc; border-radius: 12px; padding: 40px; 
      text-align: center; cursor: pointer; margin-bottom: 30px; background: white;
    }
    .upload:hover { border-color: #3498db; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .tool { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .tool img { width: 100%; height: 180px; object-fit: cover; }
    .tool h3 { padding: 15px; font-size: 1.1rem; }
    .status { padding: 15px; border-radius: 8px; margin: 20px 0; font-weight: bold; }
    .status.ok { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .status.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß ToolManager AI</h1>
    
    <div class="status" id="server-status">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
    
    <div class="upload" id="drop-area">
      ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞<br>
      <small style="color:#777">(–ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ)</small>
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
    </div>
    
    <div class="gallery" id="gallery">
      <div style="text-align:center; padding:40px; color:#777">
        –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
      </div>
    </div>
  </div>

  <script>
    let tools = JSON.parse(localStorage.getItem('tools') || '[]');
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('server-status');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É
    async function checkServer() {
      try {
        const res = await fetch('http://localhost:3000/health');
        if (res.ok) {
          statusEl.className = 'status ok';
          statusEl.innerHTML = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±—ç–∫–µ–Ω–¥—É (–ø–æ—Ä—Ç 3000)';
          return true;
        }
      } catch (e) {
        statusEl.className = 'status error';
        statusEl.innerHTML = '‚ùå –ë—ç–∫–µ–Ω–¥ –Ω–µ –∑–∞–ø—É—â–µ–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: <code>cd ~/toolmanager-ai/backend && npm start</code>';
        return false;
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    async function processFiles(files) {
      if (!await checkServer()) return;
      
      for (const file of files) {
        if (!file.type.match('image.*')) continue;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const res = await fetch('http://localhost:3000/api/analyze-tool', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: e.target.result })
            });
            
            const data = await res.json();
            if (data.error && data.fallback) {
              alert('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ä–µ–∂–∏–º (–æ—à–∏–±–∫–∞ API):\n' + data.error);
              tools.push({ ...data.fallback, image: e.target.result, date: new Date().toISOString() });
            } else {
              tools.push({ ...data, image: e.target.result, date: new Date().toISOString() });
            }
            
            localStorage.setItem('tools', JSON.stringify(tools));
            renderGallery();
          } catch (err) {
            alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + err.message);
          }
        };
        reader.readAsDataURL(file);
      }
    }
    
    function renderGallery() {
      if (tools.length === 0) {
        gallery.innerHTML = '<div style="text-align:center; padding:40px; color:#777">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</div>';
        return;
      }
      
      gallery.innerHTML = tools.map(tool => `
        <div class="tool">
          <img src="${tool.image}" alt="${tool.name}">
          <h3>${tool.name} <small style="color:#3498db">(${tool.type})</small></h3>
          <div style="padding:0 15px 15px; font-size:0.9rem; color:#777">
            –¢–æ—á–Ω–æ—Å—Ç—å: ${(tool.confidence * 100).toFixed(1)}%
          </div>
        </div>
      `).join('');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.getElementById('drop-area').addEventListener('click', () => 
      document.getElementById('fileInput').click()
    );
    
    document.getElementById('fileInput').addEventListener('change', (e) => 
      processFiles(e.target.files)
    );
    
    checkServer();
    renderGallery();
  </script>
</body>
</html>
